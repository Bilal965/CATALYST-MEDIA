{% extends 'base.html' %}
{% block title %}Upload CSV{% endblock %}
{% block content %}
<div class="container mt-5">
    <h2>Upload CSV File</h2>

    <!-- Success or error messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <form id="uploadForm" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}
        
        <button type="submit" class="btn btn-primary">Upload</button>
    </form>

    <!-- Progress bar -->
    <div class="progress mt-4">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
</div>

<script>
    // JavaScript for handling form submit and showing progress bar
    document.getElementById('uploadForm').onsubmit = function(event) {
        event.preventDefault();  // Prevent default form submission

        const formData = new FormData(this);  // Collect form data
        const xhr = new XMLHttpRequest();  // Create new XHR object
        xhr.open('POST', '', true);  // Send POST request

        // Track file upload progress
        xhr.upload.onprogress = function(event) {
            if (event.lengthComputable) {
                const percentComplete = Math.round((event.loaded / event.total) * 100);
                const progressBar = document.getElementById('progressBar');
                progressBar.style.width = percentComplete + '%';
                progressBar.innerHTML = percentComplete + '%';
                progressBar.setAttribute('aria-valuenow', percentComplete);
            }
        };

        // Show message after the upload is complete
        xhr.onload = function() {
            if (xhr.status == 200) {
                alert('File uploaded successfully!');
                location.reload();
            } else {
                alert('File upload failed!');
            }
        };

        xhr.send(formData);  // Send form data (CSV file)
    };
</script>
{% endblock %}
